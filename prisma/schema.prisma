generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String    @id @default(cuid())
  email      String    @unique
  firstName  String?
  lastName   String?
  password   String
  role       UserRole  @default(EMPLOYEE)
  businessId String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  business   Business? @relation(fields: [businessId], references: [id])

  @@map("users")
}

model Business {
  id               String              @id @default(cuid())
  name             String
  slug             String              @unique
  description      String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  addOns           AddOn[]
  experiences      Experience[]
  guests           Guest[]
  users            User[]
  analyticsTracking AnalyticsTracking[]

  @@map("businesses")
}

model Guest {
  id             String    @id @default(cuid())
  firstName      String
  lastName       String
  email          String
  phone          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  businessId     String?
  marketingOptIn Boolean   @default(false)
  zipCode        String?
  bookings       Booking[]
  business       Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@map("guests")
}

model Experience {
  id          String   @id @default(cuid())
  name        String
  slug        String
  description String?
  duration    Int
  maxCapacity Int
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(1)
  businessId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  events      Event[]
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, slug])
  @@map("experiences")
}

model Event {
  id           String       @id @default(cuid())
  name         String
  description  String?
  basePrice    Decimal      @db.Decimal(10, 2)
  startDate    DateTime
  endDate      DateTime
  maxCapacity  Int?
  isActive     Boolean      @default(true)
  experienceId String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  slug         String
  addOns       EventAddOn[]
  experience   Experience   @relation(fields: [experienceId], references: [id], onDelete: Cascade)
  sessions     Session[]

  @@unique([experienceId, slug])
  @@map("events")
}

model Session {
  id           String    @id @default(cuid())
  startTime    DateTime
  endTime      DateTime
  maxCapacity  Int?
  currentCount Int       @default(0)
  isActive     Boolean   @default(true)
  eventId      String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  bookings     Booking[]
  event        Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model AddOn {
  id           String        @id @default(cuid())
  name         String
  description  String?
  price        Decimal       @db.Decimal(10, 2)
  isActive     Boolean       @default(true)
  sortOrder    Int           @default(1)
  businessId   String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  business     Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  bookingItems BookingItem[]
  events       EventAddOn[]

  @@unique([businessId, name])
  @@map("add_ons")
}

model EventAddOn {
  id        String   @id @default(cuid())
  eventId   String
  addOnId   String
  createdAt DateTime @default(now())
  addOn     AddOn    @relation(fields: [addOnId], references: [id], onDelete: Cascade)
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, addOnId])
  @@map("event_add_ons")
}

model Booking {
  id            String                 @id @default(cuid())
  sessionId     String
  guestId       String
  quantity      Int
  total         Decimal                @db.Decimal(10, 2)
  status        BookingStatus          @default(PENDING)
  checkedIn     Boolean                @default(false)
  checkInTime   DateTime?
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  items         BookingItem[]
  communications BookingCommunication[]
  guest         Guest                  @relation(fields: [guestId], references: [id])
  session       Session                @relation(fields: [sessionId], references: [id])

  @@map("bookings")
}

model BookingItem {
  id         String          @id @default(cuid())
  bookingId  String
  addOnId    String?
  quantity   Int
  unitPrice  Decimal         @db.Decimal(10, 2)
  totalPrice Decimal         @db.Decimal(10, 2)
  itemType   BookingItemType
  createdAt  DateTime        @default(now())
  addOn      AddOn?          @relation(fields: [addOnId], references: [id])
  booking    Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("booking_items")
}

enum UserRole {
  OWNER
  EMPLOYEE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

model BookingCommunication {
  id           String               @id @default(cuid())
  bookingId    String
  type         CommunicationType
  channel      CommunicationChannel @default(EMAIL)
  direction    CommunicationDirection @default(OUTBOUND)
  status       CommunicationStatus  @default(PENDING)
  sentAt       DateTime?
  deliveredAt  DateTime?
  receivedAt   DateTime?            // For inbound messages
  errorMessage String?
  messageId    String?              // SendGrid/Twilio message ID for tracking
  subject      String?              // Email subject or SMS preview
  content      String?              // Message content (for inbound messages)
  fromAddress  String?              // Sender email/phone for inbound
  toAddress    String?              // Recipient email/phone
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  booking      Booking              @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("booking_communications")
}

enum CommunicationType {
  CONFIRMATION
  REMINDER_24H
  REMINDER_1H
  CANCELLATION
  WAIVER_REQUEST
  MARKETING
  CUSTOMER_REPLY
  CUSTOMER_INQUIRY
}

enum CommunicationChannel {
  EMAIL
  SMS
  PUSH
}

enum CommunicationDirection {
  OUTBOUND
  INBOUND
}

enum CommunicationStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
  RECEIVED
}

model AnalyticsTracking {
  id          String            @id @default(cuid())
  businessId  String
  platform    AnalyticsPlatform
  trackingId  String
  isEnabled   Boolean           @default(true)
  environment String?           // 'production', 'staging', etc.
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  business    Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, platform])
  @@map("analytics_tracking")
}

enum AnalyticsPlatform {
  GOOGLE_ANALYTICS
  META_PIXEL
  TIKTOK_PIXEL
  GOOGLE_ADS
  SNAPCHAT_PIXEL
}

enum BookingItemType {
  SESSION
  ADD_ON
}
